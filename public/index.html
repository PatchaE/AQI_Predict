<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <script src="jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="jquery.datetimepicker.min.css"/>
    <script src="jquery.datetimepicker.full.min.js"></script>
    <title>Air Quality Index</title>
    <link rel="stylesheet" href="style.css">
    <script src="lc_select.js"></script>
    <link href="themes/light.css" rel='stylesheet' type='text/css'>
</head>
<body>
    <div class="section">
        <div>
            <h2>Real Time Air Quality</h2>
            <p id="currentTime"></p> <!-- ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ -->
        </div>
        
    <div class="aqi-card">
        <div class="aqi-header">
            <div class="aqi-info">
                <span class="aqi-label">AQI</span>
                <span class="aqi-value">0</span>
            </div>
            <div class="aqi-status">
                <div style="margin-bottom: 10px;">
                    <span>Air Quality is</span>
                </div>
                <div class="status-box">Poor</div>
            </div>
        </div>
        <div class="aqi-scale">
            <span style="color:white;">Good</span>
            <span style="color: white;">Moderate</span>
            <span style="color: white;">Poor</span>
            <span style="color: white;">Unhealthy</span>
            <span style="color: white;">Severe</span>
            <span style="color: white;">Hazardous</span>
        </div>
        <div class="aqi-bar">
            <div class="bar"></div>
            <div class="aqi-marker" id="aqi-marker"></div>
            <!-- <div class="indicator" style="left: 90%;"></div> -->
        </div>
        
        <div class="aqi-values">
            <span>0</span> <span>50</span> <span>100</span> <span>150</span> <span>200</span> <span>300</span> <span>301+</span>
        </div>
    </div>

        <div class="info_graph">
            <div style="display: flex;flex-direction: row;justify-content: space-between;align-items: center;">
                <input id="datetimepicker" placeholder="Select Date" style="font-size: 16px; height: 30px; text-align: center;" readonly type="text"/>
            </div>
            
            <form>
                <select name="simple" data-placeholder="Select sensor .." style="height: 30px;">
                    <option value="Temperature">üå°Ô∏èTemperature</option>
                    <option value="Humidity">üíßHumidity</option>
                    <option value="PM2_5">üò∑PM 2.5</option>
                    <option value="PM10">ü§ßPM 10</option>
                    <option value="O3">üåçO‚ÇÉ</option>
                    <option value="CO">üè≠CO</option>
                    <option value="NO2">üè≠NO‚ÇÇ</option>
                    <option value="SO2">‚ò†Ô∏èSO‚ÇÇ</option>
                </select>
            </form>
        </div>
        <div>
            <br>
            <div id="chartContainer" style="height: 300px; width: 100%;"></div>       
            <div class="info">
                <h3>Real-Time Data</h3>
                <div id="sensorshow">
                    <div class="box">
                        <span style="font-size: 35px;">üå°Ô∏è</span>
                        <div>
                            <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô js ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÅ‡∏ó‡∏ô ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ id ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                            <div class="value">Temperature</div>
                            <div class="value" id="TempMeesage" style="margin-top: 10px;">0 ¬∞C</div>
                        </div>
                    </div>  
                </div>
            </div>
        </div>
    </div>
    <!-- Prediction -->
    <div class="section">
        <div>
            <h2>Prediction Air Quality</h2>
            <p id="currentTime_forecast">-</p>
        </div>
        
    <div class="aqi-card">
        <div class="aqi-header">
            <div class="aqi-info">
                <span class="aqi-label">AQI</span>
                <span class="aqi-value_predict">0</span>
            </div>
            <div class="aqi-status">
                <div style="margin-bottom: 10px;">
                    <span>Air Quality is</span>
                </div>
                <div class="status-box_predict">Poor</div>
            </div>
        </div>
        <div class="aqi-scale">
            <span style="color:white;">Good</span>
            <span style="color: white;">Moderate</span>
            <span style="color: white;">Poor</span>
            <span style="color: white;">Unhealthy</span>
            <span style="color: white;">Severe</span>
            <span style="color: white;">Hazardous</span>
        </div>
        <div class="aqi-bar">
            <div class="bar"></div>
            <div class="aqi-marker" id="aqi-marker_Predict"></div>
            <!-- <div class="indicator" style="left: 90%;"></div> -->
        </div>
        
        <div class="aqi-values">
            <span>0</span> <span>50</span> <span>100</span> <span>150</span> <span>200</span> <span>300</span> <span>301+</span>
        </div>
    </div>

        <div class="info_graph">
            <div style="display: flex;flex-direction: row;justify-content: space-between;align-items: center;">
                <input id="datetimepicker_predict" placeholder="Select Date" style="font-size: 16px; height: 30px; text-align: center;" readonly type="text"/>
            </div>
            
            <form>
                <select name="simple_predict" data-placeholder="Select sensor .." style="height: 30px;">
                    <option value="Temperature">üå°Ô∏èTemperature</option>
                    <option value="Humidity">üíßHumidity</option>
                    <option value="PM2_5">üò∑PM 2.5</option>
                    <option value="PM10">ü§ßPM 10</option>
                    <option value="O3">üåçO‚ÇÉ</option>
                    <option value="CO">üè≠CO</option>
                    <option value="NO2">üè≠NO‚ÇÇ</option>
                    <option value="SO2">‚ò†Ô∏èSO‚ÇÇ</option>
                </select>
            </form>
        </div>
        <div>
            <br>
            <div id="chartContainer_predict" style="height: 300px; width: 100%;"></div>       
            <div class="info">
                <h3>Latest Prediction</h3>
                <div id="sensorshow_predict">
                    <div class="box">
                        <span style="font-size: 35px;">üå°Ô∏è</span>
                        <div>
                            <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô js ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÅ‡∏ó‡∏ô ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ id ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                            <div class="value">Temperature</div>
                            <div class="value" id="TempMeesage_forecast" style="margin-top: 10px;">28.2 ¬∞C</div>
                        </div>
                    </div>  
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
<script type="text/javascript">
    let Temp_Current = 0;
    let Hum_Current = 0;
    let PM2_5_Current = 0;
    let PM10_Current = 0;
    let Ozone_Current = 0;
    let Carbon_Current = 0;
    let Nitro_Current = 0;
    let Sulfur_Current = 0;
    //////////////////////////
    let Temp_Predict = 23.8;
    let Hum_Predict = 60;
    let PM2_5_Predict = 8;
    let PM10_Predict = 10;
    let Ozone_Predict = 1;
    let Carbon_Predict = 4;
    let Nitro_Predict = 3;
    let Sulfur_Predict = 2
    let dataArray = [];
    let dataArray_predict = [];
    let aqiValue = 50; // Set your AQI value here
    let aqiPredict_Value = 180; // Set your AQI Predict value here
    let datepick = '';
    ////////////////////////RealTime/////////////

try
{
    var chart = new CanvasJS.Chart("chartContainer", {
        axisX: {
            labelFontSize: 12 // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏≠‡∏á Label ‡πÅ‡∏Å‡∏ô X
        },
		title:{
			text: "",
            fontSize: 20,
            fontColor:"black",
            fontWeight:"normal",              
		},
        zoomEnabled:false,
		data: [              
		{
			// Change type to "doughnut", "line", "splineArea", etc.
			type: "line",
            showInLegend: false,
            name: "Height(m)",
            color: "purple",
			dataPoints: [],
            lineThickness : 3
		}
		]
	    });
	    chart.render();        
}
catch{}
$("#datetimepicker").datetimepicker({
    timepicker:false,
    inline:false,
    closeOnDateSelect:true,
    value : '',
    format:'m/d/Y',
    ////////////////////////////////////////////////
    onSelectDate:function(ct,$i){
        ////////// Data base Return dataPoints //////////////
        datepick = new Date(ct).toLocaleDateString('en-CA');
        datepick = new Date(datepick).toISOString().split('T')[0];
        //console.log(datepick);  
        let date = datepick; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏õ‡∏µ-‡πÄ‡∏î‡∏∑‡∏≠‡∏ô-‡∏ß‡∏±‡∏ô
        document.querySelector("select[name=simple]").value = "";
        chart.options.data[0].dataPoints = [];

        fetch('/data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ date })  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• date ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON
        })
        .then(response => {
        if (!response.ok) 
        {
            throw new Error('Network response was not ok');
        }
            return response.json();
        })
        .then(data => {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô console ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
            //console.log('Response Data:', JSON.stringify(data));
            dataArray = JSON.parse(JSON.stringify(data));
        })
        .catch(error => {
            console.error('Error:', error);
        });
        chart.render(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏£‡∏≤‡∏ü
    }
    /////////////////////////////////////////////////
});
try
{
    const select = document.querySelector('select[name=simple]');
    new lc_select(select, {
        wrap_width: '100%',
        min_for_search: 0,
        pre_placeh_opt: true,
        on_change : function(new_value, target_field) {
            
            /////////// Loop  database insert //////////////
            //console.log(new_value[0]);
            ////////////////////////////////////////////////
            chart.options.data[0].dataPoints = [];
            try
            {
                const sensorshow = document.getElementById("sensorshow");
                sensorshow.innerHTML = ``;
                switch(new_value[0])
                    {
                        case "Temperature":
                        sensorshow.innerHTML += `
                        <div class="box">
                            <span style="font-size: 35px;">üå°Ô∏è</span>
                            <div>
                                <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô js ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÅ‡∏ó‡∏ô ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ id ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                                <div class="value">Temperature</div>
                                <div class="value" id="TempMeesage" style="margin-top: 10px;">${Temp_Current} ¬∞C</div>
                            </div>
                        </div>  
                        `
                            break;
                        case "Humidity":
                        sensorshow.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">üíß</span>
                            <div>
                                <div class="value">Humidity</div>
                                <div class="value" id="HumMeesage" style="margin-top: 10px;">${Hum_Current} %</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "PM2_5":
                        sensorshow.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">üò∑</span>
                            <div>
                                <div class="value">PM2.5</div>
                                <div class="value" id="PM2_5Meesage" style="margin-top: 10px;">${PM2_5_Current} ¬µg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "PM10":
                        sensorshow.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">ü§ß</span>
                            <div>
                                <div class="value">PM10</div>
                                <div class="value" id="PM10Meesage" style="margin-top: 10px;">${PM10_Current} ¬µg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "O3":
                        sensorshow.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">üåç</span>
                            <div>
                                <div class="value">O‚ÇÉ</div>
                                <div class="value" id="OzoneMessage" style="margin-top: 10px;">${Ozone_Current} mg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "CO":
                        sensorshow.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">üè≠</span>
                            <div>
                                <div class="value">CO</div>
                                <div class="value" id="CarbonMessage" style="margin-top: 10px;">${Carbon_Current} mg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "NO2": 
                        sensorshow.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">üè≠</span>
                            <div>
                                <div class="value">NO‚ÇÇ</div>
                                <div class="value" id="NitroMessage" style="margin-top: 10px;">${Nitro_Current} ¬µg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "SO2": 
                        sensorshow.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">‚ò†Ô∏è</span>
                            <div>
                                <div class="value">SO‚ÇÇ</div>
                                <div class="value" id="SulfurMessage" style="margin-top: 10px;">${Sulfur_Current} ¬µg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                    }
                let CheckMinMax = 0.00;
                let data_sensor = 0.00;
                let minValueExist = false;
                let maxValueExist = false;

                let date = datepick; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏õ‡∏µ-‡πÄ‡∏î‡∏∑‡∏≠‡∏ô-‡∏ß‡∏±‡∏ô
                fetch('/data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ date })  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• date ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON
                })
                .then(response => {
                if (!response.ok) 
                {
                    throw new Error('Network response was not ok');
                }
                    return response.json();
                })
                .then(data => {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô console ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
                    //console.log('Response Data:', JSON.stringify(data));
                    dataArray = JSON.parse(JSON.stringify(data));
                })
                .catch(error => {
                    console.error('Error:', error);
                });      
                  
                for (let i = 0; i < dataArray.length; i++)
                {
                    if(new Date(dataArray[i].timestamp).toISOString().split('T')[0] 
                    != new Date(datepick).toISOString().split('T')[0])
                    {
                        break;
                    }
                        
                    switch(new_value[0])
                    {
                        case "Temperature": data_sensor = dataArray[i].Temp
                        CheckMinMax = dataArray.map(item => item.Temp)
                            break;
                        case "Humidity": data_sensor = dataArray[i].Hum
                        CheckMinMax = dataArray.map(item => item.Hum)
                            break;
                        case "PM2_5": data_sensor = dataArray[i].PM2_5
                        CheckMinMax = dataArray.map(item => item.PM2_5)
                            break;
                        case "PM10": data_sensor = dataArray[i].PM10
                        CheckMinMax = dataArray.map(item => item.PM10)
                            break;
                        case "O3": data_sensor = dataArray[i].Ozone
                        CheckMinMax = dataArray.map(item => item.Ozone)
                            break;
                        case "CO": data_sensor = dataArray[i].Carbon
                        CheckMinMax = dataArray.map(item => item.Carbon)
                            break;
                        case "NO2": data_sensor = dataArray[i].Nitro
                        CheckMinMax = dataArray.map(item => item.Nitro)
                            break;
                        case "SO2": data_sensor = dataArray[i].Sulfur
                        CheckMinMax = dataArray.map(item => item.Sulfur)
                            break;
                    }
                    if(data_sensor == Math.min(...CheckMinMax) && Math.min(...CheckMinMax) != Math.max(...CheckMinMax) && minValueExist == 0)
                    {
                        minValueExist = true;
                        chart.options.data[0].dataPoints.push({ label: new Date(dataArray[i].timestamp).toLocaleString("th-TH", 
                         { hour: 'numeric', minute: 'numeric', second: 'numeric',}), 
                         y: data_sensor,
                         markerType: "cross",
                         markerColor: "blue",
                         markerSize: 10,
                         //indexLabel : "lowest",
                         /*toolTipContent : "Lowest Data : " + data_sensor*/ }); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    }
                    else if(data_sensor == Math.max(...CheckMinMax) && Math.min(...CheckMinMax) != Math.max(...CheckMinMax) && maxValueExist == 0)
                    {
                        maxValueExist = true;
                        chart.options.data[0].dataPoints.push({ label: new Date(dataArray[i].timestamp).toLocaleString("th-TH", 
                         { hour: 'numeric', minute: 'numeric', second: 'numeric',}), 
                         y: data_sensor,
                         markerType: "cross",
                         markerColor: "red",
                         markerSize: 10,
                         //indexLabel : "lowest",
                         /*toolTipContent : "Highest Data : " + data_sensor*/ }); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    }
                    else
                    {
                        chart.options.data[0].dataPoints.push({ label: new Date(dataArray[i].timestamp).toLocaleString("th-TH", 
                         { hour: 'numeric', minute: 'numeric', second: 'numeric',}), 
                         y: data_sensor }); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    }  
                }
            }
            catch{}
            chart.render(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏£‡∏≤‡∏ü
        }
    });
}catch{}


    //////////////////////Predict///////////////
try
{
    var chart_predict = new CanvasJS.Chart("chartContainer_predict", {
        axisX: {
            labelFontSize: 12 // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏≠‡∏á Label ‡πÅ‡∏Å‡∏ô X
        },
		title:{
			text: "",
            fontSize: 20,
            fontColor:"black",
            fontWeight:"normal",              
		},
        zoomEnabled:false,
		data: [              
		{
			// Change type to "doughnut", "line", "splineArea", etc.
			type: "line",
            showInLegend: false,
            name: "Height(m)",
            color: "purple",
			dataPoints: [],
            lineThickness : 3
		}
		]
	    });
	    chart_predict.render();        
}
catch{}

$("#datetimepicker_predict").datetimepicker({
    timepicker:false,
    inline:false,
    closeOnDateSelect:true,
    value : '',
    format:'m/d/Y',
    ////////////////////////////////////////////////
    onSelectDate:function(ct,$i){
        ////////// Data base Return dataPoints //////////////
        datepick = new Date(ct).toLocaleDateString('en-CA');
        datepick = new Date(datepick).toISOString().split('T')[0];
        //console.log(datepick);  
        let date = datepick; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏õ‡∏µ-‡πÄ‡∏î‡∏∑‡∏≠‡∏ô-‡∏ß‡∏±‡∏ô
        document.querySelector("select[name=simple_predict]").value = "";
        chart.options.data[0].dataPoints = [];
        ////////// ‡∏£‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô path //////////////////////
        fetch('/data_predict', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ date })  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• date ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON
        })
        .then(response => {
        if (!response.ok) 
        {
            throw new Error('Network response was not ok');
        }
            return response.json();
        })
        .then(data => {
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô console ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
            //console.log('Response Data:', JSON.stringify(data));
            dataArray_predict = JSON.parse(JSON.stringify(data));
        })
        .catch(error => {
            console.error('Error:', error);
        });
        chart_predict.render(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏£‡∏≤‡∏ü
    }
    /////////////////////////////////////////////////
});
try
{
    const select_predict = document.querySelector('select[name=simple_predict]');
    new lc_select(select_predict, {
        wrap_width: '100%',
        min_for_search: 0,
        pre_placeh_opt: true,
        on_change : function(new_value, target_field) {
            
            /////////// Loop  database insert //////////////
            //console.log(new_value[0]);
            ////////////////////////////////////////////////
            chart_predict.options.data[0].dataPoints = [];
            try
            {
                const sensorshow_predict = document.getElementById("sensorshow_predict");
                sensorshow_predict.innerHTML = ``;
                switch(new_value[0])
                    {
                        case "Temperature":
                        sensorshow_predict.innerHTML += `
                        <div class="box">
                            <span style="font-size: 35px;">üå°Ô∏è</span>
                            <div>
                                <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô js ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÅ‡∏ó‡∏ô ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ id ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                                <div class="value">Temperature</div>
                                <div class="value" id="TempMeesage_forecast" style="margin-top: 10px;">${Temp_Predict} ¬∞C</div>
                            </div>
                        </div>  
                        `
                            break;
                        case "Humidity":
                        sensorshow_predict.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">üíß</span>
                            <div>
                                <div class="value">Humidity</div>
                                <div class="value" id="HumMeesage_forecast" style="margin-top: 10px;">${Hum_Predict} %</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "PM2_5":
                        sensorshow_predict.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">üò∑</span>
                            <div>
                                <div class="value">PM2.5</div>
                                <div class="value" id="PM2_5Meesage_forecast" style="margin-top: 10px;">${PM2_5_Predict} ¬µg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "PM10":
                        sensorshow_predict.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">ü§ß</span>
                            <div>
                                <div class="value">PM10</div>
                                <div class="value" id="PM10Meesage_forecast" style="margin-top: 10px;">${PM10_Predict} ¬µg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "O3":
                        sensorshow_predict.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">üåç</span>
                            <div>
                                <div class="value">O‚ÇÉ</div>
                                <div class="value" id="OzoneMessage_forecast" style="margin-top: 10px;">${Ozone_Predict} mg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "CO":
                        sensorshow_predict.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">üè≠</span>
                            <div>
                                <div class="value">CO</div>
                                <div class="value" id="CarbonMessage_forecast" style="margin-top: 10px;">${Carbon_Predict} mg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "NO2": 
                        sensorshow_predict.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">üè≠</span>
                            <div>
                                <div class="value">NO‚ÇÇ</div>
                                <div class="value" id="NitroMessage_forecast" style="margin-top: 10px;">${Nitro_Predict}0 ¬µg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                        case "SO2": 
                        sensorshow_predict.innerHTML += `
                        <div class="box">
                            <span style="font-size: 36px;">‚ò†Ô∏è</span>
                            <div>
                                <div class="value">SO‚ÇÇ</div>
                                <div class="value" id="SulfurMessage_forecast" style="margin-top: 10px;">${Sulfur_Predict} ¬µg/m¬≥</div>
                            </div>
                        </div> 
                        `
                            break;
                    }
                let CheckMinMax = 0.00;
                let data_sensor = 0.00;
                let minValueExist = false;
                let maxValueExist = false;

                for (let i = 0; i < dataArray_predict.length; i++)
                {
                    if(new Date(dataArray_predict[i].timestamp).toISOString().split('T')[0] 
                    != new Date(datepick).toISOString().split('T')[0])
                    {
                        break;
                    }
                        
                    switch(new_value[0])
                    {
                        case "Temperature": data_sensor = dataArray_predict[i].Temp
                        CheckMinMax = dataArray_predict.map(item => item.Temp)
                            break;
                        case "Humidity": data_sensor = dataArray_predict[i].Hum
                        CheckMinMax = dataArray_predict.map(item => item.Hum)
                            break;
                        case "PM2_5": data_sensor = dataArray_predict[i].PM2_5
                        CheckMinMax = dataArray_predict.map(item => item.PM2_5)
                            break;
                        case "PM10": data_sensor = dataArray_predict[i].PM10
                        CheckMinMax = dataArray_predict.map(item => item.PM10)
                            break;
                        case "O3": data_sensor = dataArray_predict[i].Ozone
                        CheckMinMax = dataArray_predict.map(item => item.Ozone)
                            break;
                        case "CO": data_sensor = dataArray_predict[i].Carbon
                        CheckMinMax = dataArray_predict.map(item => item.Carbon)
                            break;
                        case "NO2": data_sensor = dataArray_predict[i].Nitro
                        CheckMinMax = dataArray_predict.map(item => item.Nitro)
                            break;
                        case "SO2": data_sensor = dataArray_predict[i].Sulfur
                        CheckMinMax = dataArray_predict.map(item => item.Sulfur)
                            break;
                    }
                    if(data_sensor == Math.min(...CheckMinMax) && Math.min(...CheckMinMax) != Math.max(...CheckMinMax) && minValueExist == 0)
                    {
                        minValueExist = true;
                        chart_predict.options.data[0].dataPoints.push({ label: new Date(dataArray_predict[i].timestamp).toLocaleString("th-TH", 
                         { hour: 'numeric', minute: 'numeric', second: 'numeric',}), 
                         y: data_sensor,
                         markerType: "cross",
                         markerColor: "blue",
                         markerSize: 10,
                         //indexLabel : "lowest",
                         /*toolTipContent : "Lowest Data : " + data_sensor*/ }); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    }
                    else if(data_sensor == Math.max(...CheckMinMax) && Math.min(...CheckMinMax) != Math.max(...CheckMinMax) && maxValueExist == 0)
                    {
                        maxValueExist = true;
                        chart_predict.options.data[0].dataPoints.push({ label: new Date(dataArray_predict[i].timestamp).toLocaleString("th-TH", 
                         { hour: 'numeric', minute: 'numeric', second: 'numeric',}), 
                         y: data_sensor,
                         markerType: "cross",
                         markerColor: "red",
                         markerSize: 10,
                         //indexLabel : "lowest",
                         /*toolTipContent : "Highest Data : " + data_sensor*/ }); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    }
                    else
                    {
                        chart_predict.options.data[0].dataPoints.push({ label: new Date(dataArray_predict[i].timestamp).toLocaleString("th-TH", 
                         { hour: 'numeric', minute: 'numeric', second: 'numeric',}), 
                         y: data_sensor }); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                    }  
                }
            }
            catch{}
            chart_predict.render(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Å‡∏£‡∏≤‡∏ü
        }
    });
}catch{}
    
    
    //////////////////////////////////////////////
    function updateTime() 
    {
        let now = new Date();
        document.getElementById("currentTime").textContent = now.toLocaleString("en-CA", {
        weekday: 'long', month: 'long', day: 'numeric', year: "numeric" , hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }
    function updateDateTime_forecase() ////////// Edit Here forecast //////////////////
    {
        let now = new Date();
        now.setHours(now.getHours() + 1);
        document.getElementById("currentTime_forecast").textContent = now.toLocaleString("en-CA", {
        weekday: 'long', month: 'long', day: 'numeric', year: "numeric" , hour: '2-digit', minute: '2-digit', second: '2-digit'
        });  
        // document.getElementById("TempMeesage_forecast").innerHTML = Temp_Current + " ¬∞C";
        // document.getElementById("HumMeesage_forecast").innerHTML = Hum_Current + " %";    
        // document.getElementById("PM2_5Meesage_forecast").innerHTML = "PM2.5 <br><br>" + PM2_5_Current + " ¬µg/m¬≥";
        // document.getElementById("PM10Meesage_forecast").innerHTML = "PM10 <br><br>" + PM10_Current + " ¬µg/m¬≥";    
        // document.getElementById("OzoneMessage_forecast").innerHTML = "O‚ÇÉ <br><br>" + Ozone_Current + " mg/m¬≥";
        // document.getElementById("CarbonMessage_forecast").innerHTML = "CO <br><br>" + Carbon_Current + " mg/m¬≥"; 
        // document.getElementById("NitroMessage_forecast").innerHTML = "NO‚ÇÇ <br><br>" + Nitro_Current + " ¬µg/m¬≥";
        // document.getElementById("SulfurMessage_forecast").innerHTML = "SO‚ÇÇ <br><br>" + Sulfur_Current + " ¬µg/m¬≥"; 

    }   
    function updateEveryHour() 
    {
        updateTime();
        updateDateTime_forecase();
        setInterval(updateTime, 1000);
        setInterval(updateDateTime_forecase, 3600000); // Update every 1 hour (3600000 ms)
    }        
    var broker = {
        hostname: "broker.emqx.io",
        port: 8084,
        clientId: "web_" + Math.random().toString(16).substr(2, 8)
    };

    var topic = "IQA_Test/+";

    // MQTT client instance
    var client = new Paho.MQTT.Client(broker.hostname, broker.port, broker.clientId);

    function onConnect() {
        console.log("Connected to MQTT broker");
        client.subscribe(topic);
        //client.subscribe('IQA_Test/Hum');
        console.log("Subscribed to topic: " + topic);
    }

    function onFailure(message) {
        console.log("Connection to MQTT broker failed: " + message.errorMessage);
    } 

    function onMessageArrived(message) 
    {
        
        //console.log("Topic: " + message.destinationName);
        if(message.destinationName == "IQA_Test/Temp" 
        && document.querySelector("select[name=simple]").value == "Temperature")
        {
             Temp_Current = message.payloadString;
             document.getElementById("TempMeesage").innerText = Temp_Current + " ¬∞C";
        }  
        else if(message.destinationName == "IQA_Test/Hum"
        && document.querySelector("select[name=simple]").value == "Humidity")
        {
            Hum_Current = message.payloadString;
            document.getElementById("HumMeesage").innerHTML = Hum_Current + " %";
        }
        else if(message.destinationName == "IQA_Test/PM2_5"
        && document.querySelector("select[name=simple]").value == "PM2_5")
        {
            PM2_5_Current = message.payloadString;
            document.getElementById("PM2_5Meesage").innerHTML = PM2_5_Current + " ¬µg/m¬≥";
        }  
        else if(message.destinationName == "IQA_Test/PM10"
        && document.querySelector("select[name=simple]").value == "PM10")
        {
            PM10_Current = message.payloadString;
            document.getElementById("PM10Meesage").innerHTML = PM10_Current + " ¬µg/m¬≥";
        }
        else if(message.destinationName == "IQA_Test/Ozone"
        && document.querySelector("select[name=simple]").value == "O3")
        {
            Ozone_Current = message.payloadString;
            document.getElementById("OzoneMessage").innerHTML = Ozone_Current + " mg/m¬≥";
        }  
        else if(message.destinationName == "IQA_Test/Carbon"
        && document.querySelector("select[name=simple]").value == "CO")
        {
            Carbon_Current = message.payloadString;
            document.getElementById("CarbonMessage").innerHTML = Carbon_Current + " mg/m¬≥";
        }
        if(message.destinationName == "IQA_Test/Nitro"
        && document.querySelector("select[name=simple]").value == "NO2")
        {
            Nitro_Current = message.payloadString;
            document.getElementById("NitroMessage").innerHTML = Nitro_Current + " ¬µg/m¬≥";
        }  
        else if(message.destinationName == "IQA_Test/Sulfur"
        && document.querySelector("select[name=simple]").value == "SO2")
        {
            Sulfur_Current = message.payloadString;
            document.getElementById("SulfurMessage").innerHTML = Sulfur_Current + " ¬µg/m¬≥";
        }
    }

        // Set callback functions
        client.onConnectionLost = onFailure;
        client.onMessageArrived = onMessageArrived;

        // Connect to MQTT broker
        client.connect({
            onSuccess: onConnect,
            onFailure: onFailure,
            useSSL: true,
            userName: "",
            password: ""
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        
    updateEveryHour();
    /////////////////////////// Actual //////////////////////
    
    let maxAqi = 320;
    const marker = document.getElementById('aqi-marker');
    const containerWidth = document.querySelector('.aqi-bar').offsetWidth;

    const markerPosition = (aqiValue / maxAqi) * containerWidth;
    marker.style.left = `${markerPosition}px`;
    
    if(aqiValue >= 0 && aqiValue <= 50) // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    {
        document.querySelectorAll(".status-box").forEach(el => el.textContent = "Good");
        document.querySelector(".status-box").style.color = "lawngreen";
        document.querySelectorAll(".aqi-value").forEach(el => {
            el.textContent = aqiValue;
            el.style.color = "lawngreen"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    else if(aqiValue >= 51 && aqiValue <= 100) // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
    {
        document.querySelectorAll(".status-box").forEach(el => el.textContent = "Moderate");
        document.querySelector(".status-box").style.color = "yellow";
        document.querySelectorAll(".aqi-value").forEach(el => {
            el.textContent = aqiValue;
            el.style.color = "yellow"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    else if(aqiValue >= 100 && aqiValue <= 150) // ‡∏™‡∏µ‡∏™‡πâ‡∏°
    {
        document.querySelectorAll(".status-box").forEach(el => el.textContent = "Poor");
        document.querySelector(".status-box").style.color = "orange";
        document.querySelectorAll(".aqi-value").forEach(el => {
            el.textContent = aqiValue;
            el.style.color = "orange"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    else if(aqiValue >= 151 && aqiValue <= 200) // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
    {
        document.querySelectorAll(".status-box").forEach(el => el.textContent = "Unhealthy");
        document.querySelector(".status-box").style.color = "red";
        document.querySelectorAll(".aqi-value").forEach(el => {
            el.textContent = aqiValue;
            el.style.color = "red"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    else if(aqiValue >= 201 && aqiValue <= 300) // ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á
    {
        document.querySelectorAll(".status-box").forEach(el => el.textContent = "Servere");
        document.querySelector(".status-box").style.color = "purple";
        document.querySelectorAll(".aqi-value").forEach(el => {
            el.textContent = aqiValue;
            el.style.color = "purple"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    else // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
    {
        document.querySelectorAll(".status-box").forEach(el => el.textContent = "Hazardous");
        document.querySelector(".status-box").style.color = "brown";
        document.querySelectorAll(".aqi-value").forEach(el => {
            el.textContent = aqiValue;
            el.style.color = "brown"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    /////////////////////////////////////////////////////////
    /////////////////////////// Prediction //////////////////////
    
    let maxAqi_Predict = 320;
    const marker_Predict = document.getElementById('aqi-marker_Predict');
    const containerWidth_Predict = document.querySelector('.aqi-bar').offsetWidth;

    const markerPosition_Predict = (aqiPredict_Value / maxAqi_Predict) * containerWidth_Predict;
    marker_Predict.style.left = `${markerPosition_Predict}px`;

    
    if(aqiPredict_Value >= 0 && aqiPredict_Value <= 50) // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
    {
        document.querySelectorAll(".status-box_predict").forEach(el => el.textContent = "Good");
        document.querySelector(".status-box_predict").style.color = "lawngreen";
        document.querySelectorAll(".aqi-value_predict").forEach(el => {
            el.textContent = aqiPredict_Value;
            el.style.color = "lawngreen"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    else if(aqiPredict_Value >= 51 && aqiPredict_Value <= 100) // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
    {
        document.querySelectorAll(".status-box_predict").forEach(el => el.textContent = "Moderate");
        document.querySelector(".status-box_predict").style.color = "yellow";
        document.querySelectorAll(".aqi-value_predict").forEach(el => {
            el.textContent = aqiPredict_Value;
            el.style.color = "yellow"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    else if(aqiPredict_Value >= 100 && aqiPredict_Value <= 150) // ‡∏™‡∏µ‡∏™‡πâ‡∏°
    {
        document.querySelectorAll(".status-box_predict").forEach(el => el.textContent = "Poor");
        document.querySelector(".status-box_predict").style.color = "orange";
        document.querySelectorAll(".aqi-value_predict").forEach(el => {
            el.textContent = aqiPredict_Value;
            el.style.color = "orange"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    else if(aqiPredict_Value >= 151 && aqiPredict_Value <= 200) // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
    {
        document.querySelectorAll(".status-box_predict").forEach(el => el.textContent = "Unhealthy");
        document.querySelector(".status-box_predict").style.color = "red";
        document.querySelectorAll(".aqi-value_predict").forEach(el => {
            el.textContent = aqiPredict_Value;
            el.style.color = "red"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    else if(aqiPredict_Value >= 201 && aqiPredict_Value <= 300) // ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á
    {
        document.querySelectorAll(".status-box_predict").forEach(el => el.textContent = "Servere");
        document.querySelector(".status-box_predict").style.color = "purple";
        document.querySelectorAll(".aqi-value_predict").forEach(el => {
            el.textContent = aqiPredict_Value;
            el.style.color = "purple"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    else // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
    {
        document.querySelectorAll(".status-box_predict").forEach(el => el.textContent = "Hazardous");
        document.querySelector(".status-box_predict").style.color = "brown";
        document.querySelectorAll(".aqi-value_predict").forEach(el => {
            el.textContent = aqiPredict_Value;
            el.style.color = "brown"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "green", "blue", "#ff6600"
        });
    }
    /////////////////////////////////////////////////////////
</script>